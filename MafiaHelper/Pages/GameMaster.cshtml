@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<div class="max-w-5xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold dark:text-gray-100">Game Master Dashboard</h2>
        <div class="space-x-2">
            <button id="settings" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">Settings</button>
            <button id="deal" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">Deal Roles</button>
        </div>
    </div>

    <!-- Grid Layout -->
    <div class="grid grid-cols-3 gap-4">
        <!-- Role Config -->
        <div id="role-config" class="bg-white dark:bg-gray-700 p-4 rounded shadow hidden">
            <h3 class="font-bold mb-2 dark:text-gray-100">Role Configuration</h3>
            <div class="space-y-2">
                <div class="flex items-center">
                    <input type="checkbox" id="role-mafia" class="h-4 w-4" />
                    <label for="role-mafia" class="ml-2 flex-1 dark:text-gray-200">Mafia</label>
                    <input type="number" id="role-mafia-count" min="1" class="w-16 px-2 py-1 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100" value="1" />
                </div>
                <div class="flex items-center"><input id="role-sheriff" type="checkbox" class="h-4 w-4" /><label for="role-sheriff" class="ml-2 flex-1 dark:text-gray-200">Sheriff</label></div>
                <div class="flex items-center"><input id="role-doctor" type="checkbox" class="h-4 w-4" /><label for="role-doctor" class="ml-2 flex-1 dark:text-gray-200">Doctor</label></div>
                <div class="flex items-center"><input id="role-putana" type="checkbox" class="h-4 w-4" /><label for="role-putana" class="ml-2 flex-1 dark:text-gray-200">Putana</label></div>
                <div class="flex items-center"><input id="role-maniac" type="checkbox" class="h-4 w-4" /><label for="role-maniac" class="ml-2 flex-1 dark:text-gray-200">Maniac</label></div>
                <div class="flex items-center"><input id="role-immortal" type="checkbox" class="h-4 w-4" /><label for="role-immortal" class="ml-2 flex-1 dark:text-gray-200">Immortal</label></div>
            </div>
            <button id="update-roles" class="mt-4 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Update Roles</button>
        </div>

        <!-- Players & Roles -->
        <div id="player-list" class="bg-white dark:bg-gray-700 p-4 rounded shadow overflow-y-auto max-h-96">
            <h3 class="font-bold mb-2 dark:text-gray-100">Players & Roles</h3>
            <ul id="players" class="divide-y divide-gray-200 dark:divide-gray-600"></ul>
        </div>

        <!-- Voting Window -->
        <div id="vote-window" class="bg-white dark:bg-gray-700 p-4 rounded shadow">
            <h3 class="font-bold mb-2 dark:text-gray-100">Voting</h3>
            <button id="start-vote" class="mb-2 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition">Start Voting</button>
            <div id="current-voter" class="font-semibold dark:text-gray-200 mb-2"></div>
            <div id="vote-list" class="grid grid-cols-2 gap-2 mb-2"></div>
            <div id="vote-result" class="mt-2 dark:text-gray-200"></div>
        </div>

        <!-- Timer -->
        <div id="timer-window" class="bg-white dark:bg-gray-700 p-4 rounded shadow flex flex-col items-center">
            <h3 class="font-bold mb-2 dark:text-gray-100">Timer</h3>
            <div id="timer-display" class="text-4xl font-mono dark:text-gray-200">60</div>
            <button id="start-timer" class="mt-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">Start 60s</button>
        </div>

        <!-- Night Phase -->
        <div id="night-window" class="bg-white dark:bg-gray-700 p-4 rounded shadow">
            <h3 class="font-bold mb-2 dark:text-gray-100">Night Phase</h3>
            <div id="current-phase" class="mb-2 font-semibold dark:text-gray-200"></div>
            <div id="night-roles" class="space-y-2 mb-4"></div>
            <button id="next-night" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600 transition">Next</button>
        </div>

        <!-- Notes -->
        <div id="notes-window" class="bg-white dark:bg-gray-700 p-4 rounded shadow">
            <h3 class="font-bold mb-2 dark:text-gray-100">Notes</h3>
            <textarea id="notes" class="w-full h-40 p-2 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100" placeholder="Type notes here..."></textarea>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        const conn = new signalR.HubConnectionBuilder().withUrl("/gamehub").build();
        let players = [];
        const dead = {};
        let alivePlayers = [];
        let voteCounts = {};
        let voterIndex = 0;

        const colorMap = {
          mafia: 'text-red-600 dark:text-red-400',
          sheriff: 'text-green-600 dark:text-green-400',
          doctor: 'text-blue-600 dark:text-blue-400',
          putana: 'text-pink-600 dark:text-pink-400',
          maniac: 'text-purple-600 dark:text-purple-400',
          immortal: 'text-gray-600 dark:text-gray-400',
          villager: 'text-gray-50 dark:text-white'
        };

        function renderPlayers() {
          const ul = document.getElementById('players'); ul.innerHTML = '';
          players.forEach(p => {
            if (dead[p.name] === undefined) dead[p.name] = false;
            const li = document.createElement('li');
            li.className = dead[p.name]
              ? 'p-1 flex justify-between opacity-50 line-through'
              : 'p-1 flex justify-between';
            const nm = document.createElement('span');
            nm.textContent = p.name;
            nm.className = 'font-medium dark:text-gray-100';
            const rv = document.createElement('span');
            rv.textContent = p.role || '…waiting…';
            rv.className = `italic ${colorMap[(p.role||'').toLowerCase()] || 'text-gray-600 dark:text-gray-400'}`;
            const btn = document.createElement('button');
            btn.textContent = dead[p.name] ? 'Revive' : 'Kill';
            btn.className = dead[p.name]
              ? 'ml-2 px-2 py-1 bg-green-500 text-white rounded'
              : 'ml-2 px-2 py-1 bg-red-500 text-white rounded';
            btn.onclick = () => {
              dead[p.name] = !dead[p.name];
              renderPlayers();
            };
            li.append(nm, rv, btn);
            ul.appendChild(li);
          });
        }

        conn.on('PlayersUpdated', list => {
          players = list;
          renderPlayers();
        });

        document.getElementById('start-vote').onclick = () => {
          alivePlayers = players.filter(p => !dead[p.name]);
          voteCounts = {};
          voterIndex = 0;
          const voteList = document.getElementById('vote-list'); voteList.innerHTML = '';
          alivePlayers.forEach(p => {
            voteCounts[p.name] = 0;
            const btn = document.createElement('button');
            btn.className = 'flex justify-between items-center px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded';
            const nameSpan = document.createElement('span'); nameSpan.textContent = p.name;
            const countSpan = document.createElement('span'); countSpan.textContent = '0'; countSpan.className = 'ml-2 font-bold';
            btn.append(nameSpan, countSpan);
            btn.onclick = () => {
              voteCounts[p.name]++;
              countSpan.textContent = voteCounts[p.name];
              voterIndex++;
              if (voterIndex < alivePlayers.length) {
                document.getElementById('current-voter').textContent = `Voter: ${alivePlayers[voterIndex].name}`;
              } else {
                endVoting();
              }
            };
            voteList.appendChild(btn);
          });
          if (alivePlayers.length) {
            document.getElementById('current-voter').textContent = `Voter: ${alivePlayers[0].name}`;
            document.getElementById('vote-result').textContent = '';
          }
        };

        function endVoting() {
          const entries = Object.entries(voteCounts);
          const max = Math.max(...entries.map(e => e[1]));
          const top = entries.filter(e => e[1] === max).map(e => e[0]);
          let res = '';
          if (max === 0 || top.length === alivePlayers.length) {
            res = 'No one is kicked.';
          } else if (top.length === 1) {
            res = `${top[0]} is kicked.`;
          } else {
            res = `Revote: ${top.join(' & ')}`;
          }
          document.getElementById('vote-result').textContent = res;
          document.getElementById('current-voter').textContent = 'Voting complete';
        }

        // Timer
        document.getElementById('start-timer').onclick = () => {
          let time = 60;
          clearInterval(window.timerInterval);
          const disp = document.getElementById('timer-display'); disp.textContent = time;
          window.timerInterval = setInterval(() => {
            time--; disp.textContent = time; if (time <= 0) clearInterval(window.timerInterval);
          }, 1000);
        };

        // Night Phase
        conn.on('RoleConfigsUpdated', configs => {
          const roles = configs.filter(c => c.Enabled || c.enabled).map(c => c.Name || c.name);
          nightRoles = roles;
          nightIndex = 0;
          const div = document.getElementById('night-roles'); div.innerHTML = '';
          roles.forEach(r => {
            const el = document.createElement('div'); el.textContent = r;
            el.className = 'px-2 py-1 bg-blue-200 dark:bg-blue-600 rounded'; div.appendChild(el);
          });
          document.getElementById('current-phase').textContent = '';
        });
        document.getElementById('next-night').onclick = () => {
          const cp = document.getElementById('current-phase');
          if (nightIndex < nightRoles.length) {
            cp.textContent = `Phase: ${nightRoles[nightIndex]}`;
            nightIndex++;
          } else {
            cp.textContent = 'Night complete'; nightIndex = 0;
          }
        };

        // Settings
        document.getElementById('settings').onclick = () => document.getElementById('role-config').classList.toggle('hidden');
        document.getElementById('update-roles').onclick = () => {
          const names = ['Mafia','Sheriff','Doctor','Putana','Maniac','Immortal'];
          const configs = names.map(name => ({ Name: name, Enabled: document.getElementById('role-'+name.toLowerCase()).checked, Count: name==='Mafia'? parseInt(document.getElementById('role-mafia-count').value)||1 :1 }));
          conn.invoke('UpdateRoleConfigs', configs).then(() => document.getElementById('role-config').classList.add('hidden'));
        };

        // Deal & init
        document.getElementById('deal').onclick = () => conn.invoke('DealRoles');
        conn.start().then(() => conn.invoke('RegisterGM')).catch(console.error);
    </script>
}
